<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Admin Girişi • TourVoice</title>
  <link rel="icon" href="/admin/favicon.svg" />
  <style>
    :root{color-scheme:dark light}
    *{box-sizing:border-box}
    body{
      margin:0;
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:#0b0f14;color:#e7ecf2;
      display:flex;min-height:100vh;align-items:center;justify-content:center;
    }
    .card{
      width:min(560px,92vw);
      background:#0f1621;border:1px solid #1e2a36;border-radius:16px;
      padding:24px 20px; box-shadow:0 20px 60px rgba(0,0,0,.35)
    }
    h1{margin:0 0 6px;font-size:26px}
    p.muted{margin:0 0 14px;color:#9aafc3;font-size:14px}
    .error{margin:10px 0 16px;color:#ff6b6b;font-weight:600;min-height:22px;white-space:pre-line}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input{
      width:100%;padding:12px 14px;border-radius:10px;
      border:1px solid #223040;background:#0b121b;color:#e7ecf2;
    }
    button{
      width:100%;padding:12px 14px;border-radius:10px;border:none;cursor:pointer;
      background:#0d66ff;color:#fff;font-weight:700
    }
    button[disabled]{opacity:.6;cursor:not-allowed}
    .help{margin-top:10px;color:#7fa6ff;font-size:13px}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #223040;border-radius:999px;background:#101823;color:#a8bbd4;font-size:12px}
  </style>
</head>
<body>
  <main class="card">
    <h1>Admin Girişi</h1>
    <p class="muted">Sadece <code class="pill">superadmin: true</code> custom claim’i olan kullanıcılar giriş yapabilir.</p>

    <div id="err" class="error"></div>

    <div class="row">
      <input id="email" type="email" autocomplete="username" placeholder="E-posta (örn. admin@tourvoice.app)" />
      <input id="pass" type="password" autocomplete="current-password" placeholder="Şifre" />
      <button id="loginBtn">Giriş yap</button>
    </div>

    <div class="help" id="info"></div>
  </main>

  <!-- Firebase SDK’leri (Hosting auto-init ▶ config sızdırmaz) -->
  <script src="/__/firebase/10.12.4/firebase-app-compat.js"></script>
  <script src="/__/firebase/10.12.4/firebase-auth-compat.js"></script>
  <script src="/__/firebase/init.js"></script>

  <script>
    // ---- Firebase ----
    const app  = firebase.app();
    const auth = firebase.auth();

    // Bilgi amaçlı: hangi anahtar ile init olduğunu göster
    (function showInfo(){
      try {
        const apiKey = app.options?.apiKey || "(yok)";
        document.getElementById('info').textContent =
          `Bağlantı hazır • API key (auto-init): ${apiKey.slice(0,6)}•••`;
      } catch(_){}
    })();

    const $ = (id) => document.getElementById(id);
    const setErr = (msg='') => { $('err').textContent = msg; };
    const busy = (v) => { $('loginBtn').disabled = !!v; };

    $('loginBtn').onclick = async () => {
      setErr(''); busy(true);
      const email = $('email').value.trim();
      const pass  = $('pass').value;

      try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        const { user } = await auth.signInWithEmailAndPassword(email, pass);
        const tok = await user.getIdTokenResult(true);
        if (tok?.claims?.superadmin === true) {
          // Başarılı: admin paneline yönlendir
          location.href = '/admin/'; 
        } else {
          await auth.signOut();
          setErr('Bu hesap için superadmin yetkisi bulunmuyor.');
        }
      } catch (e) {
        setErr(`Giriş hatası: ${e.message || e.code || e}`);
      } finally {
        busy(false);
      }
    };

    // Zaten oturum açıksa claim kontrolü yap ve içeri al
    auth.onAuthStateChanged(async (user) => {
      if (!user) return;
      try {
        const tok = await user.getIdTokenResult(true);
        if (tok?.claims?.superadmin === true) location.href = '/admin/';
      } catch(_) {}
    });
  </script>
</body>
</html>
